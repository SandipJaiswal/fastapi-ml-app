name: CI/CD FastAPI ML App

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ Set a dynamic image tag: timestamp + short commit SHA
      - name: Set image tag
        id: vars
        run: echo "IMAGE_TAG=$(date +%s)-${GITHUB_SHA::7}" >> $GITHUB_ENV

      # 3️⃣ Log in to Docker registry
      - name: Log in to Docker registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASS }}

      # 4️⃣ Build Docker image with dynamic tag
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.REGISTRY_URL }}/fastapi-ml-app:${{ env.IMAGE_TAG }} .

      # 5️⃣ Push Docker image to registry
      - name: Push Docker image
        run: |
          docker push ${{ secrets.REGISTRY_URL }}/fastapi-ml-app:${{ env.IMAGE_TAG }}

      # 6️⃣ Trigger ArgoCD image override sync
      - name: Trigger ArgoCD sync with new image
        run: |
          curl -X POST \
          -u admin:${{ secrets.ARGOCD_PASSWORD }} \
          -H "Content-Type: application/json" \
          -d '{
                "revision": "HEAD",
                "resources": [],
                "strategy": {
                  "apply": {
                    "force": true
                  }
                },
                "overrides": {
                  "fastapi-ml": {
                    "image": "${{ secrets.REGISTRY_URL }}/fastapi-ml-app:${{ env.IMAGE_TAG }}"
                  }
                }
              }' \
          http://192.168.0.201:8080/api/v1/applications/fastapi-ml/sync

